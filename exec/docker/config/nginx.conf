user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;

    keepalive_timeout	1000;

    client_max_body_size 100M;
    proxy_buffer_size   128k;
    proxy_buffers   4 256k;
    proxy_busy_buffers_size   256k;
    client_body_buffer_size      2m;
    client_header_buffer_size    16k;
    large_client_header_buffers  8 8k;
    fastcgi_buffers              512 16k;
    fastcgi_buffer_size          512k;
    fastcgi_busy_buffers_size    512k;
    
    upstream jenkins-app {
	keepalive 32;
        server jenkins-master:8080;
    }

    upstream api-app {
        keepalive 32;
 	server api-server:8080;
    }

    upstream monitoring-app {
        keepalive 32;
	server grafana:3000;
    }

    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    server {
	    listen 80 default_server;
	    listen [::]:80 default_server;

	    server_name  {service_name};

	    location /.well-known/acme-challenge/ {
	        allow all;
                root /var/www/certbot;
	    }

	    location /stub_status {
	        allow all; 
                stub_status;
	    }

            location / {
                return 301 https://$host$request_uri;
            }
    }

    server {
        listen 443 ssl default_server;
        listen [::]:443 ssl default_server;

        server_name {service_name}; 

        ssl_certificate /etc/letsencrypt/live/{service_name}/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/{service_name}/privkey.pem;

        location /jenkins/ {
	    proxy_pass http://jenkins-app;
	    
	    proxy_set_header Connection $connection_upgrade;
	    proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_max_temp_file_size 0;
        }

 	location /api/ {
            proxy_pass http://api-app;
 
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_max_temp_file_size 0;
 	    proxy_buffering off;
 	    proxy_read_timeout 86400s;
         }

	 location /api-swagger {
	     proxy_pass http://api-app;

	     proxy_set_header Connection $connection_upgrade;
             proxy_set_header Upgrade $http_upgrade;
             proxy_set_header Host $http_host;
             proxy_set_header X-Real-IP $remote_addr;
             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
             proxy_set_header X-Forwarded-Proto $scheme;
             proxy_max_temp_file_size 0;
             proxy_buffering off;
             proxy_read_timeout 86400s;
	 }

	 location /swagger-ui/ {
	     proxy_pass http://api-app;

	     proxy_set_header Connection $connection_upgrade;
             proxy_set_header Upgrade $http_upgrade;
             proxy_set_header Host $http_host;
             proxy_set_header X-Real-IP $remote_addr;
             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
             proxy_set_header X-Forwarded-Proto $scheme;
             proxy_max_temp_file_size 0;
             proxy_buffering off;
             proxy_read_timeout 86400s;
	 }

	 location /v3/api-docs {
	     proxy_pass http://api-app;

             proxy_set_header Connection $connection_upgrade;
             proxy_set_header Upgrade $http_upgrade;
             proxy_set_header Host $http_host;
             proxy_set_header X-Real-IP $remote_addr;
             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
             proxy_set_header X-Forwarded-Proto $scheme;
             proxy_max_temp_file_size 0;
             proxy_buffering off;
             proxy_read_timeout 86400s;
	 }

	 location /controller {
             root /usr/share/nginx/html;
	     autoindex on;
	 }

	 location /monitoring/ {
            proxy_pass http://monitoring-app;

            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_max_temp_file_size 0;
            proxy_buffering off;
            proxy_read_timeout 86400s;
         }

	 location / {
            proxy_pass http://{service_name}.s3-website.ap-northeast-2.amazonaws.com;

	    resolver 8.8.8.8 8.8.8.4;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
	    proxy_buffering off;
	    proxy_read_timeout 86400s;
            proxy_max_temp_file_size 0;
        }
    }
}

